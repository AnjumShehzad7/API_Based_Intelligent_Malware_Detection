from tkinter import *
import virustotal_python
from pprint import pprint
import zipfile
from tkinter import filedialog
from VTService import VTService
import time


        #######################################################################################
                                        # virus total API's

def vt():
    vt_service = VTService()

    file_name = 1

    vt_api_keys = [
        "76ebd939301445249b9dfd7bb58e8be4d85f572de382cd6eceeb4a56ad7587f6",
        "583680f214840a461ead2cec8fae769c1eb3ee5461e362455e0d6daf38be12db",
        "02e4d9d35863b2c2e057289311bbd37f2eb21a7dd2496a04d298b3e680de2fd5",
        "a2db6727abaf1f4908d2d422c15371d25c9bc7debdc0fd23a4f50426d24e5a96",
        "ab8421085f362f075cc88cb1468534253239be0bc482da052d8785d422aaabd7",
        "ac6f89d4a5f58fa8d539d0e07de38d4f73012954348123d5cfdaa63f503ad706",
        "72b066aa76a58a2a29e0bc58fb85271e9a4222c552ecf97701f8526edd49670f",
        "d92949f61388b91e18c5c75a0c668e7cc512039b719d2d5523266e843982a599",
        "7d0967f369b915aceec2b784c7d425f6c113e0b2713d4c221e78d9b507e9eeb7",
        "6d179b22ca63010c75c01e0df2e6f2b5492b1b17d61fd036498b8c65a14e5c3f",
        "a2114d52e027e3cbe908f75eef6343e2210918cd348e360d9ba523f52ae6a227",
        "35008f6f8c59a23e388fea8128618bb3ceb17b6b3b34003dbdb6025d44c31819",
        "0202c928cb410a25b09b6c635aab89b86fed89446c7f34d8167985bdcdda17a4"
    ]

    index = 0

    vt_api_key_index = 0

    for i in range(263):

        if i < 262:
            continue

        file = open("malware_hascode/" + str(i), "r")
        vt_result_file = open("malware_vt_result/" + str(i), "w")

        print("FileName : " + str(i))

        for line in file:
            index = index + 1
            vt_api_key = vt_api_keys[vt_api_key_index]
            response = vt_service.fetch_engine_values(line.strip(), vt_api_key)
            print(str(time.strftime("%H-%M-%S")) + ": " + str(index) + ": " + vt_api_key + ": " + response)

            vt_api_key_index = vt_api_key_index + 1

            if vt_api_key_index == len(vt_api_keys):
                vt_api_key_index = 0

            try:
                vt_result_file.write(response + "\n")
            except Exception as e:
                vt_result_file.write("Error\n")
                print(e)

            time.sleep(0.5)

        vt_result_file.close()
        file.close()
    #######################################################################################

    #######################################################################################
                                    #Zip file extraction

def UploadAction():
        global path
        path = filedialog.askopenfilename(initialdir="/", title="open file",
                                          filetypes=(("zip file", ".zip"), ("all files", ".txt")))
        search_label["text"] = path

def extraction():
        # path=label["text"]
        archive = zipfile.ZipFile(path, "r")
        index = 0
        file_name = 0
        for malware_file_name in archive.filelist:
            print(malware_file_name.filename)

            if index == 500:
                index = 0
                file_name = file_name + 1

            if index == 0:
                hascode_file = open(path + str(file_name), "w")

            hascode = fetch_hascode_from_file_name(malware_file_name.filename)
            hascode_file.write(hascode + "\n")

            index = index + 1

def fetch_hascode_from_file_name(file_name):
        if not "VirusShare" in file_name:
            return None

        start = file_name.find("_")
        if start < 1:
            return ""
        return file_name[start + 1:]

        #######################################################################################
                                        # Get JSON report
def virus_api():
    # The ID (either SHA-256, SHA-1 or MD5 hash) identifying the file
    FILE_ID = "9f101483662fc071b7c10f81c64bb34491ca4a877191d464ff46fd94c7247115"

    with virustotal_python.Virustotal("ab8421085f362f075cc88cb1468534253239be0bc482da052d8785d422aaabd7") as vtotal:
        resp = vtotal.request(f"files/{FILE_ID}")
        pprint(resp.data)
        #######################################################################################
                                        # GUI

w2 = Tk()
w2.geometry("1366x768")
w2.title('API Based Intelligent Malware Identification (Virus Total)')

# Header
Label(w2, text="API Based Intelligent Malware Identification ", width=47,
      font=("bold", 40)).place(x=1,y=25)

# file
Button(w2, bg="gray", fg="white", text='Upload Data Set', width=25, font=("bold", 12)
       ,command=UploadAction).place(x=250, y=120)

text = Entry(w2, state='disabled', bg="white")
search_label = Label(text, text="No File Selected", font=("bold", 12))
search_label.pack(side=LEFT)
text.place(x=500, y=120, width=380,height=35)

# file-extraction
Button(w2, bg="gray", fg="white", text='Extract', font=("bold", 12), width=25,
       command=extraction).place(x=620, y=175)

# cuckoo button
Button(w2, bg="gray", fg="white", text='Upload Files on Virus Total',command=vt,
       font=("bold", 12),width=25).place(x=620, y=225)

# Json button
Button(w2, bg="gray", fg="white", text='Get Report',
       command=virus_api,
       font=("bold", 12), width=25).place(x=620, y=275)

# Feature Engineering button
Button(w2, bg="gray", fg="white", text="Extract Features",
       font=("bold", 12), width=25).place(x=620, y=325)

# Classification Button
Button(w2, bg='gray', fg='white', text="Classify",
       font=("bold", 12), width=25).place(x=620, y=375)

# label Classification
Label(w2, text="Classification Result", width=35,
      font=("bold", 20)).place(x=457, y=440)

# Classification Result Text
Text(w2, width=70,height=9).place(x=460, y=485)

Button(w2, bg='gray', fg='white', text="Exit", font=("bold", 12),
       width=25, command=w2.destroy).place(x=630,y=645)


w2.mainloop()